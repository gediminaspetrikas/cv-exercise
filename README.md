# CV Exercise
Goal:
Create a service deployment which demonstrates asynchronous communication between API and data processing layer using SQS and DynamoDB using Serverless framework.

## Tech Details
The service consists of two stacks:
- Node.js API layer with Typescript
- Python data processing service

Deployment sequence:
- Deploy resources (DynamoDB, SQS)
- Deploy Node.js API
- Deploy Python service

Uses [Github Actions](https://github.com/gediminaspetrikas/cv-exercise/blob/master/.github/workflows/main.yml)

I've decided to move out resource declaration to a separate serverless stack to reduce complexity of service serverless configurations.

System diagram:

![Diagram](https://github.com/gediminaspetrikas/cv-exercise/blob/main/diagram.png?raw=true)

### Node.js API Layer
Endpoints:
- POST `/jobs`
  - returns:
    ```
    status: 202
    body:
    {
        "jobId": "cf3d2a60-7475-11eb-a146-c989cbb137a9"
    }
    ```
  - Creates a SQS message with the same `jobId` passed as a parameter.
- GET `/jobs/{id}`
  - returns:
    ```
    status: 200
    body:
    {
        "jobId": "cf3d2a60-7475-11eb-a146-c989cbb137a9",
        "text": "d03f0460-7475-11eb-99d7-4ef189663d6b"
    }
    ```
    `text` stands for data generated by Python data processing service.
  - Fetches an entry from DynamoDB if such exists, otherwise returns `404`.

### Python Data Processing Service
Listens to a SQS queue and acts upon receiving event. Generates a UUID and inserts an item to DynamoDB as `text` field. Uses `jobId` as PK.

## Quirks
Client cannot identify if a job is being processed or even exists if called before Python lambda is finished. Can be solved by using an additional layer of persistance to track the state of jobs. Decided to omit this feature to limit the scope of the exercise.

## Encountered Issues
### `/EventSourceArn: failed validation constraint for keyword [pattern]`
Caused by CI AWS account having `0` as the first character in `accountId`. 
Fixed by passing a hardcoded `accountId` in Data Service lambda for registering an event when to call a handler.

Related project code: https://github.com/gediminaspetrikas/cv-exercise/blob/master/services/data/serverless.yml#L26

Reference issue: https://github.com/aws/serverless-application-model/issues/1699

### serverless configuration templating fails for SQS IAM statements
For some reason SQS IAM policy's resource template is not being transformed correctly, causing templating keywords pushed to IAM Policy statement. Does not occur with DynamoDB resources. Can potentially be related to having an `accountId` starting with a `0`.
